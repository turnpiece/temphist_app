# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
  desc "Regenerate certificates (nuke and recreate)"
  lane :regenerate_certificates do
    setup_ci 

    # Set up API key for App Store Connect
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_KEY_ID"],
      issuer_id: ENV["APP_STORE_ISSUER_ID"],
      key_content: ENV["APP_STORE_PRIVATE_KEY"],
      is_key_content_base64: true
    )

    # Clear any existing keychain issues
    clear_derived_data

    # Nuke existing certificates first
    match(
      api_key: api_key,
      type: "development",
      readonly: false
    )
    
    match(
      api_key: api_key,
      type: "distribution",
      readonly: false
    )

    UI.success("✅ Certificate regeneration complete!")
  end

  desc "Push a new beta build to TestFlight"
  lane :beta do
    # Set up authentication for automatic signing FIRST (before setup_ci)
    ENV["SPACESHIP_CONNECT_API_KEY_ID"] = ENV["APP_STORE_KEY_ID"]
    ENV["SPACESHIP_CONNECT_API_ISSUER_ID"] = ENV["APP_STORE_ISSUER_ID"]
    ENV["SPACESHIP_CONNECT_API_PRIVATE_KEY_CONTENT"] = ENV["APP_STORE_PRIVATE_KEY"]
    ENV["SPACESHIP_CONNECT_API_IN_HOUSE"] = "false"

    setup_ci 

    # Set up API key for App Store Connect
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_KEY_ID"],
      issuer_id: ENV["APP_STORE_ISSUER_ID"],
      key_content: ENV["APP_STORE_PRIVATE_KEY"],
      is_key_content_base64: true
    )

    # Clear any existing keychain issues
    clear_derived_data

    IOS_DIR   = File.expand_path('..', __dir__)   # .../ios
    REPO_ROOT = File.expand_path('..', IOS_DIR)   # repo root

    # Prepare Flutter deps (repo root)
    Dir.chdir(REPO_ROOT) { sh("flutter pub get") }

    # Ensure pods are installed (ios dir)
    Dir.chdir(IOS_DIR)   { sh("bundle exec pod install --repo-update") }

    # bump build number to current UTC timestamp YYYYMMDDHHMM
    increment_build_number(
      xcodeproj: "Runner.xcodeproj",
      build_number: Time.now.utc.strftime("%Y%m%d%H%M")
    )

    # Debug information
    UI.message("Using bundle id: #{ENV['IOS_BUNDLE_ID'] || 'com.turnpiece.temphist'}")
    UI.message("Using team id: #{ENV['APPLE_TEAM_ID'] || '77X2NFV437'}")
    UI.message("Provisioning profile specifier: match AppStore #{ENV['IOS_BUNDLE_ID'] || 'com.turnpiece.temphist'}")
    UI.message("DEVELOPER_DIR: #{ENV['DEVELOPER_DIR']}")

    # Ensure we have the right certificates and profiles
    match(
      api_key: api_key,
      type: "appstore",
      readonly: true
    )

    # Verify scheme, print signing, and build (ios dir)
    Dir.chdir(IOS_DIR) do
      # quick context
      sh "pwd && ls -la"
      sh "xcrun --sdk iphoneos --show-sdk-version || true"

      UI.user_error!("Runner.xcworkspace not found in #{IOS_DIR}") unless File.exist?(File.join(IOS_DIR, "Runner.xcworkspace"))

      # verify the scheme is shared (keep as-is)
      sh %q[xcodebuild -list -workspace ./Runner.xcworkspace | sed -n '/Schemes:/,$p']
      out = sh(%q[xcodebuild -list -workspace ./Runner.xcworkspace | grep -E '^\s*Runner$' || true]).to_s.strip
      UI.user_error!("Xcode scheme 'Runner' is not shared or missing. In Xcode: Product > Scheme > Manage Schemes… check 'Shared' for Runner, then commit the .xcscheme.") if out.empty?

      # helpful: what destinations are available?
      sh %q[xcodebuild -showdestinations -workspace ./Runner.xcworkspace -scheme Runner || true]

      # assert the installed provisioning profile matches our specifier (keep)
      spec = "match AppStore #{ENV['IOS_BUNDLE_ID'] || 'com.turnpiece.temphist'}"
      sh %Q[grep -l "#{spec}" ~/Library/MobileDevice/Provisioning\\ Profiles/*.mobileprovision || true]

      # print signing settings – add a destination so Xcode resolves settings
      sh %q[xcodebuild -showBuildSettings -workspace ./Runner.xcworkspace -scheme Runner -configuration Release -destination 'generic/platform=iOS' | egrep "CODE_SIGN|PROVISION|DEVELOPMENT_TEAM|PRODUCT_BUNDLE_IDENTIFIER|CODE_SIGNING_ALLOWED" || true]

      # identities + installed profiles (keep)
      sh %q[security find-identity -v -p codesigning ~/Library/Keychains/fastlane_tmp_keychain-db || true]
      sh %q[ls -l ~/Library/MobileDevice/Provisioning\ Profiles || true]

      # archive with gym (workspace path is correct from ios/)
      build_app(
        workspace: "./Runner.xcworkspace",
        scheme: "Runner",
        configuration: "Release",
        export_method: "app-store",
        skip_profile_detection: true,
        xcargs: %Q[
          CODE_SIGN_STYLE=Manual
          DEVELOPMENT_TEAM=#{ENV["APPLE_TEAM_ID"] || "77X2NFV437"}
          CODE_SIGN_IDENTITY="Apple Distribution"
          PROVISIONING_PROFILE_SPECIFIER="match AppStore #{ENV["IOS_BUNDLE_ID"] || "com.turnpiece.temphist"}"
        ],
        export_options: {
          provisioningProfiles: {
            "#{ENV["IOS_BUNDLE_ID"] || "com.turnpiece.temphist"}" => "match AppStore #{ENV["IOS_BUNDLE_ID"] || "com.turnpiece.temphist"}"
          }
        },
        sdk: "iphoneos",
        destination: "generic/platform=iOS",
        buildlog_path: "~/Library/Logs/gym"
      )
    end

    upload_to_testflight(api_key: api_key)
  end
end
