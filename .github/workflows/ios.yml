name: iOS Build (Flutter)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-15
    env:
      IOS_BUNDLE_ID: com.turnpiece.temphist
      APPLE_TEAM_ID: 77X2NFV437

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v3

      - name: Select Xcode 16.0 (stable)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.0"

      - name: Finalize Xcode & ensure iPhoneOS platform
        shell: bash
        run: |
          set -euo pipefail

          # Match setup-xcode's choice in both xcode-select and env
          SELECTED_DIR="$(xcode-select -p)"
          echo "Selected by setup-xcode: ${SELECTED_DIR}"
          sudo xcode-select -s "${SELECTED_DIR}"

          # Export DEVELOPER_DIR for this shell and all later steps
          export DEVELOPER_DIR="${SELECTED_DIR}"
          echo "DEVELOPER_DIR=${SELECTED_DIR}" >> "$GITHUB_ENV"

          # Guard against stray SDK root that confuses tools
          unset MD_APPLE_SDK_ROOT || true
          echo "MD_APPLE_SDK_ROOT=" >> "$GITHUB_ENV"

          # First-launch bits (idempotent)
          sudo xcodebuild -license accept || true
          sudo xcodebuild -runFirstLaunch || true

          echo "Before download; existing iPhoneOS SDKs (if any):"
          ls -1 "${DEVELOPER_DIR}/Platforms/iPhoneOS.platform/Developer/SDKs" || true

          # Always attempt to install the iOS platform; safe if already present
          echo "Downloading iOS platform (idempotent)"
          sudo xcodebuild -downloadPlatform iOS || true

          echo "After download; installed iPhoneOS SDKs:"
          ls -1 "${DEVELOPER_DIR}/Platforms/iPhoneOS.platform/Developer/SDKs" || true

          echo "Using Xcode:"
          xcodebuild -version
          echo "DEVELOPER_DIR=${DEVELOPER_DIR}"
          echo "xcrun iphoneos SDK version:"
          xcrun --sdk iphoneos --show-sdk-version || true

          echo "Destinations sanity check:"
          xcodebuild -showdestinations -workspace ios/Runner.xcworkspace -scheme Runner || true

      - name: Update version for release
        run: |
          # Check if this is a tag push or branch push
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # This is a tag push - extract version and update
            VERSION=${GITHUB_REF#refs/tags/}
            RELEASE_DATE=$(date +'%Y-%m-%d')
            echo "Tag detected: $VERSION"
            echo "Setting release date to: $RELEASE_DATE"
            
            # Update version in all config files
            sed -i '' "s/appVersion = '.*'/appVersion = '${VERSION#v}'/" lib/config/*.dart
            
            # Update release date in all config files  
            sed -i '' "s/releaseDate = '.*'/releaseDate = '$RELEASE_DATE'/" lib/config/*.dart
            
            echo "Version and release date update complete"
          else
            # This is a branch push - just log and continue
            echo "Branch push detected: $GITHUB_REF"
            echo "No version update needed for branch push"
            echo "Version will be updated when a tag is pushed"
          fi

      - name: üöÄ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.8"
          channel: "stable"

      - name: üîç Check Flutter and Dart versions
        run: |
          flutter --version
          dart --version

      - name: üì¶ Install dependencies
        run: flutter pub get

      - name: üß™ Run tests
        run: flutter test

      - name: üîê Decode GoogleService-Info.plist
        run: |
          echo "${{ secrets.GOOGLE_SERVICE_INFO_PLIST_B64 }}" | base64 --decode > ios/Runner/GoogleService-Info.plist

      - name: Clear match cache
        run: rm -rf ~/Library/MobileDevice/Provisioning\ Profiles/*

      - name: Remove old match repo
        run: rm -rf /Users/runner/.fastlane/ci/*

      - name: Clean DerivedData
        run: rm -rf ~/Library/Developer/Xcode/DerivedData

      - name: Clean keychains
        run: |
          security delete-keychain /Users/runner/Library/Keychains/fastlane_tmp_keychain-db || true
          rm -rf /Users/runner/Library/Keychains/fastlane_tmp_keychain-db

      - name: Create keychain
        run: |
          security create-keychain -p "" /Users/runner/Library/Keychains/fastlane_tmp_keychain-db
          security set-keychain-settings -t 3600 -l /Users/runner/Library/Keychains/fastlane_tmp_keychain-db
          security list-keychains -d user -s /Users/runner/Library/Keychains/fastlane_tmp_keychain-db

      - name: üõ†Ô∏è Install Fastlane
        working-directory: ios
        run: bundle install

      - name: üì¶ Clean and Install CocoaPods dependencies
        working-directory: ios
        run: |
          rm -rf Pods
          rm -f Podfile.lock
          bundle exec pod install

      - name: üîç List available iOS simulators
        run: xcrun simctl list devices available

      - name: üöÄ Upload to TestFlight with Fastlane
        working-directory: ios
        run: bundle exec fastlane beta --verbose
        env:
          FLUTTER_BUILD_MODE: release
          APP_STORE_KEY_ID: ${{ secrets.APP_STORE_KEY_ID }}
          APP_STORE_ISSUER_ID: ${{ secrets.APP_STORE_ISSUER_ID }}
          APP_STORE_PRIVATE_KEY: ${{ secrets.APP_STORE_PRIVATE_KEY }}
          APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
          APP_STORE_TEAM_ID: ${{ secrets.APP_STORE_TEAM_ID }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: https://x-access-token:${{ secrets.MATCH_GIT_PAT }}@github.com/turnpiece/apple-certs.git
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          FASTLANE_DISABLE_COLORS: 1

      - name: Upload Xcode logs and SDK layout
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xcode-logs-and-sdk
          path: |
            ~/Library/Logs/gym
            ~/Library/Developer/Xcode/DerivedData/**/Logs
            $DEVELOPER_DIR/Platforms/iPhoneOS.platform/Developer/SDKs

      - name: ‚úÖ Archive output
        run: |
          mkdir -p build-artifacts
          IPA_PATH=$(find ios -name "*.ipa" | head -n 1)
          echo "Found IPA at: $IPA_PATH"
          cp "$IPA_PATH" build-artifacts/

      - name: üíæ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app
          path: build-artifacts
